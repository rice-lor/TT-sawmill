<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sawmill Status</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: transparent;
            color: #f0f0f0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .status-window {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 280px;
            min-width: 200px;
            height: 70px;
            min-height: 60px;
            background-color: rgba(30, 30, 30, 0.9);
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            resize: both;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header-bar {
            background-color: rgba(50, 50, 50, 0.9);
            padding: 6px 12px;
            cursor: move;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            user-select: none;
            text-align: center;
            font-size: 12px;
            color: #bb86fc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-bar h2 {
            margin: 0;
            font-size: 12px;
            font-weight: normal;
        }
        
        .version-tag {
            font-size: 11px;
            color: #888;
        }

        .status-content {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="status-window" id="draggableWindow">
        <div class="header-bar" id="dragHandle">
            <h2>Sawmill Automation</h2>
            <span class="version-tag">v1.0</span>
        </div>
        <div class="status-content">
            <span id="status-text">Initializing...</span>
        </div>
    </div>

    <script>
    (() => {
        // --- CONFIGURATION & CONSTANTS ---
        const CONFIG = {
            LOGGING_CAMP_MENU: "Trucking: Logging Camp",
            SAWMILL_MENU: "The Sawmill Faction",
            VEHICLE_MODEL: "trailerlarge",
            INVENTORY_LOG_CAPACITY: 5,
            VEHICLE_LOG_CAPACITY: 170,
            DEBOUNCE_DELAY_MS: 3000
        };

        const ACTIONS = {
            COLLECT_LOGS_10: "Collect Logs x10",
            COLLECT_LOGS_5: "Collect Logs x5",
            DUMP_FROM_TRUNK: "Dump from Trunk",
            OPEN_STORAGE: "Open Storage",
            PUT_ALL: "Put All",
            MOC_TRAILER: "Mobile Operations Center (MK14) (trailerlarge)"
        };

        // --- STATE & CACHE ---
        let cache = {};
        let lastActionTimestamp = 0;
        let isProcessing = false;

        // --- UI ELEMENTS ---
        const statusText = document.getElementById('status-text');
        const draggableWindow = document.getElementById('draggableWindow');
        const dragHandle = document.getElementById('dragHandle');

        // --- UI LOGIC ---
        let isDragging = false;
        let offsetX, offsetY;

        dragHandle.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - draggableWindow.getBoundingClientRect().left;
            offsetY = e.clientY - draggableWindow.getBoundingClientRect().top;
            draggableWindow.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            draggableWindow.style.left = `${e.clientX - offsetX}px`;
            draggableWindow.style.top = `${e.clientY - offsetY}px`;
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                draggableWindow.style.userSelect = 'auto';
            }
        });

        // --- CORE AUTOMATION LOGIC ---
        function postCommand(type, data = {}) {
            window.parent.postMessage({ type, ...data }, "*");
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function waitUntil(conditionFn, retries, timeout, errorMessage = "Wait operation timed out.") {
            return new Promise(async (resolve, reject) => {
                while (!conditionFn()) {
                    if (retries-- <= 0) return reject(new Error(errorMessage));
                    await sleep(timeout);
                }
                await sleep(100);
                resolve(true);
            });
        }
        
        async function forceMenuChoice(choiceText) {
            const initialMenuChoices = JSON.stringify(cache.menu_choices);
            const choiceWithTags = cache.menu_choices.find(c => c && typeof c[0] === 'string' && c[0].replace(/(<.+?>)|(&#.+?;)/g, "").trim().includes(choiceText));
            
            if (!choiceWithTags) {
                throw new Error(`Could not find choice containing "${choiceText}"`);
            }

            postCommand("forceMenuChoice", { choice: choiceWithTags[0], mod: 0 });

            if (choiceText === ACTIONS.PUT_ALL) {
                await sleep(200);
                return;
            }

            try {
                await waitUntil(() => JSON.stringify(cache.menu_choices) !== initialMenuChoices, 200, 5);
            } catch (e) { /* It's okay if this times out */ }
        }

        function getStorageContent(storageKey) {
            const content = cache[storageKey];
            if (!content || content === "{}") return { tcargologs: { amount: 0 } };
            try {
                // Ensure content is a string before parsing
                const contentString = typeof content === 'string' ? content : JSON.stringify(content);
                const parsed = JSON.parse(contentString);
                return parsed.tcargologs ? parsed : { tcargologs: { amount: 0 } };
            } catch (e) {
                return { tcargologs: { amount: 0 } };
            }
        }

        async function handleLoggingCamp() {
            if (isProcessing || Date.now() - lastActionTimestamp < CONFIG.DEBOUNCE_DELAY_MS) return;
            isProcessing = true;

            try {
                const userId = cache.user_id;
                if (!userId) return;

                const vehicleStorageKey = `chest_u${userId}veh_trailer_${CONFIG.VEHICLE_MODEL}`;
                const vehicleLogAmount = (getStorageContent(vehicleStorageKey).tcargologs?.amount) || 0;
                const inventoryLogAmount = (getStorageContent('inventory').tcargologs?.amount) || 0;

                if (vehicleLogAmount < CONFIG.VEHICLE_LOG_CAPACITY) {
                    postCommand("sendCommand", { command: "rm_trunk" });
                    await sleep(500);
                    await waitUntil(() => cache.menu === CONFIG.LOGGING_CAMP_MENU, 50, 100);
                    await forceMenuChoice(ACTIONS.COLLECT_LOGS_10);
                } else if (inventoryLogAmount < CONFIG.INVENTORY_LOG_CAPACITY) {
                    await forceMenuChoice(ACTIONS.COLLECT_LOGS_5);
                }
            } finally {
                isProcessing = false;
                lastActionTimestamp = Date.now();
            }
        }

        async function handleSawmill() {
            if (isProcessing || Date.now() - lastActionTimestamp < CONFIG.DEBOUNCE_DELAY_MS) return;
            isProcessing = true;

            try {
                const userId = cache.user_id;
                if (!userId) return;

                const vehicleStorageKey = `chest_u${userId}veh_trailer_${CONFIG.VEHICLE_MODEL}`;
                const vehicleLogAmount = (getStorageContent(vehicleStorageKey).tcargologs?.amount) || 0;
                const inventoryLogAmount = (getStorageContent('inventory').tcargologs?.amount) || 0;

                if (vehicleLogAmount > 0) {
                    await forceMenuChoice(ACTIONS.DUMP_FROM_TRUNK);
                    await waitUntil(() => cache.menu_choices.some(c => c[0].includes(ACTIONS.MOC_TRAILER)), 100, 10);
                    await forceMenuChoice(ACTIONS.MOC_TRAILER);
                } else if (inventoryLogAmount > 0) {
                    await forceMenuChoice(ACTIONS.OPEN_STORAGE);
                    await waitUntil(() => cache.menu_choices.some(c => c[0].includes(ACTIONS.PUT_ALL)), 100, 10);
                    await forceMenuChoice(ACTIONS.PUT_ALL);
                }
            } finally {
                isProcessing = false;
                lastActionTimestamp = Date.now();
            }
        }

        function updateStatusDisplay() {
             const userId = cache.user_id;
             if (!userId) {
                statusText.textContent = "Waiting for User ID...";
                return;
             }
             const vehicleStorageKey = `chest_u${userId}veh_trailer_${CONFIG.VEHICLE_MODEL}`;
             const vehicleLogAmount = (getStorageContent(vehicleStorageKey).tcargologs?.amount) || 0;
             const inventoryLogAmount = (getStorageContent('inventory').tcargologs?.amount) || 0;

             if (vehicleLogAmount > 0 || inventoryLogAmount > 0) {
                 statusText.textContent = "Waiting for Storage Menu";
             } else {
                 statusText.textContent = "Waiting for Logs Menu";
             }
        }

        // --- EVENT LISTENERS ---
        window.addEventListener("message", (event) => {
            const data = event.data;
            if (!data || !data.data) return;
            
            const receivedData = data.data;
            
            for (const [key, value] of Object.entries(receivedData)) {
                // Special handling for menu_choices which might be a string or an array
                if (key === 'menu_choices') {
                    if (typeof value === 'string') {
                        try {
                            cache[key] = JSON.parse(value || "[]");
                        } catch {
                            cache[key] = [];
                        }
                    } else if (Array.isArray(value)) {
                        cache[key] = value;
                    } else {
                        cache[key] = [];
                    }
                } else {
                    cache[key] = value;
                }
            }
            
            updateStatusDisplay();
            
            if (cache.menu_open) {
                if (cache.menu === CONFIG.LOGGING_CAMP_MENU) {
                    handleLoggingCamp();
                } else if (cache.menu === CONFIG.SAWMILL_MENU) {
                    handleSawmill();
                }
            }
        });

        document.addEventListener("DOMContentLoaded", function() {
            postCommand("getData");
            updateStatusDisplay();

            const escapeListener = (e) => {
                if (e.key === "Escape") {
                    postCommand("pin");
                }
            };
            window.addEventListener('keydown', escapeListener);
        });
    })();
    </script>
</body>
</html>

